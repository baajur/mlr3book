<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>0.1 DALEX | 08-interpretation-dalex.utf8</title>
  <meta name="description" content="" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="0.1 DALEX | 08-interpretation-dalex.utf8" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="0.1 DALEX | 08-interpretation-dalex.utf8" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  


<script src="libs/header-attrs-2.1/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">mlr3 Manual <img src='https://raw.githubusercontent.com/mlr-org/mlr3/master/man/figures/logo.png' width=30 /></a></li>

<li class="divider"></li>
<li class="chapter" data-level="0.1" data-path=""><a href="#dalex"><i class="fa fa-check"></i><b>0.1</b> DALEX</a>
<ul>
<li class="chapter" data-level="0.1.1" data-path=""><a href="#read-data-fifa20-interpretability-data-fifa"><i class="fa fa-check"></i><b>0.1.1</b> Read data: FIFA20 {interpretability-data-fifa}</a></li>
<li class="chapter" data-level="0.1.2" data-path=""><a href="#train-a-model-ranger-interpretability-train-ranger"><i class="fa fa-check"></i><b>0.1.2</b> Train a model: Ranger {interpretability-train-ranger}</a></li>
<li class="chapter" data-level="0.1.3" data-path=""><a href="#prepare-an-explainer"><i class="fa fa-check"></i><b>0.1.3</b> Prepare an explainer</a></li>
<li class="chapter" data-level="0.1.4" data-path=""><a href="#model-audit"><i class="fa fa-check"></i><b>0.1.4</b> Model audit</a></li>
<li class="chapter" data-level="0.1.5" data-path=""><a href="#global-understanding"><i class="fa fa-check"></i><b>0.1.5</b> Global understanding</a></li>
<li class="chapter" data-level="0.1.6" data-path=""><a href="#instance-understanding"><i class="fa fa-check"></i><b>0.1.6</b> Instance understanding</a></li>
<li class="chapter" data-level="0.1.7" data-path=""><a href="#models-comparison"><i class="fa fa-check"></i><b>0.1.7</b> Models comparison</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!--bookdown:title:end-->
<!--bookdown:title:start-->
<div id="dalex" class="section level2" number="0.1">
<h2><span class="header-section-number">0.1</span> DALEX</h2>
<p>The DALEX package xrays any predictive model and helps to explore and explain its behaviour. The package implements collection of methods for <a href="https://pbiecek.github.io/ema/">Explanatory Model Analysis</a> which is summarised in the Figure <a href="#fig:DALEXema">1</a>.</p>
<p>In the following sections we will present subsequent methods available in the DALEX package based on the gbm model trained for valuation of players on the FIFA 20 database.</p>
<p>Structure of this chapter is following:</p>
<ul>
<li>In section <a href="#sec:interpretability-train-ranger"><strong>??</strong></a> we train a <code>gbm</code> regression model for FIFA 20 dataset introdiced in section <a href="#interpretability-data-fifa"><strong>??</strong></a>,</li>
<li>Sections … - … are devoted to exploration of a single model.</li>
<li>Sections … - … are devoted to instance level exploration</li>
<li>Sections … - … are devoted to dataset level exploration</li>
<li>In sections … we show how to use the <code>DALEX</code> library to compare multiple models.</li>
</ul>
<div class="figure" style="text-align: center"><span id="fig:DALEXema"></span>
<img src="images/DALEX_ema.png" alt="Pyramid with the methods of model exploration presented in this chapter." width="100%" />
<p class="caption">
Figure 1: Pyramid with the methods of model exploration presented in this chapter.
</p>
</div>
<div id="read-data-fifa20-interpretability-data-fifa" class="section level3" number="0.1.1">
<h3><span class="header-section-number">0.1.1</span> Read data: FIFA20 {interpretability-data-fifa}</h3>
<p>For examples we use data retrieved from FIFA20 video game. The raw dat is avaliable at <a href="https://www.kaggle.com/stefanoleone992/fifa-20-complete-player-dataset">FIFA20</a>. After some basic data cleaning, the processed data is avaiable at <a href="https://github.com/pbiecek/explainFIFA20">explainFIFA20</a> website.</p>
<p>It can be read directly from the GitHub with a single instruction.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>fifa20 &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="kw">url</span>(<span class="st">&quot;https://github.com/pbiecek/explainFIFA20/blob/master/fifa20.rds?raw=true&quot;</span>))</span></code></pre></div>
<p>The dataset contains data on almost 18 thousand players. For every player we have 41 features available.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">dim</span>(fifa20)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">## [1] 17969    41</span></span></code></pre></div>
<p>One of the features, called <code>value_eur</code>, is the worth of a footballer in euros. We will build a prediction model, which will estimate the worth of the player on the basis of other features.</p>
</div>
<div id="train-a-model-ranger-interpretability-train-ranger" class="section level3" number="0.1.2">
<h3><span class="header-section-number">0.1.2</span> Train a model: Ranger {interpretability-train-ranger}</h3>
<p>The DALEX package works for any model regardless of its internal structure. Examples of how this package works are shown on a random forest model implemented in the <code>ranger</code> package.</p>
<p>We use the <code>mlr3</code> package to build a predictive model. Since the <code>value_eur</code> feature is strongly diagonal, we will build a model for the logarithm of this price.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">library</span>(<span class="st">&quot;mlr3&quot;</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw">library</span>(<span class="st">&quot;mlr3learners&quot;</span>)</span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a>fifa_task &lt;-<span class="st"> </span>TaskRegr<span class="op">$</span><span class="kw">new</span>(<span class="dt">id =</span> <span class="st">&quot;FIFA20&quot;</span>, <span class="dt">backend =</span> fifa20, <span class="dt">target =</span> <span class="st">&quot;value_eur&quot;</span>)</span>
<span id="cb3-5"><a href="#cb3-5"></a></span>
<span id="cb3-6"><a href="#cb3-6"></a>fifa_ranger &lt;-<span class="st"> </span><span class="kw">lrn</span>(<span class="st">&quot;regr.ranger&quot;</span>)</span>
<span id="cb3-7"><a href="#cb3-7"></a>fifa_ranger<span class="op">$</span>param_set<span class="op">$</span>values &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">num.trees =</span> <span class="dv">250</span>)</span>
<span id="cb3-8"><a href="#cb3-8"></a>fifa_ranger<span class="op">$</span><span class="kw">train</span>(fifa_task)</span></code></pre></div>
</div>
<div id="prepare-an-explainer" class="section level3" number="0.1.3">
<h3><span class="header-section-number">0.1.3</span> Prepare an explainer</h3>
<p>To get started with the exploration of model behavior we need to create explainer that is a unified interface that lets us achieve explanations in the future. DALEX::explain function handles is for all types of predictive models, but in the extension, DALEXtra package, there is dedicated DALEXtra::explain_mlr3 function.</p>
<p>Note that model is trained on the logarithm of the value, but it will be much more natural to operate on values in Euro. This is why in explainer we specified a user-defined predict function that transforms log value to the value in Euro. In this function <code>yhat</code> stands for default predict function used with mlr3 models and implemented in DALEXtra. Hadn’t we provided custom predict_function, <code>yhat</code> would have been used as a default parameter.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">library</span>(<span class="st">&quot;DALEX&quot;</span>)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">library</span>(<span class="st">&quot;DALEXtra&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a>fifa_ranger_exp &lt;-<span class="st"> </span><span class="kw">explain_mlr3</span>(fifa_ranger,</span>
<span id="cb4-5"><a href="#cb4-5"></a>        <span class="dt">data =</span> fifa20_selected, <span class="dt">y =</span> <span class="dv">10</span><span class="op">^</span>fifa20_selected<span class="op">$</span>value_eur,</span>
<span id="cb4-6"><a href="#cb4-6"></a>        <span class="dt">predict_function =</span> <span class="cf">function</span>(m,x) <span class="dv">10</span><span class="op">^</span><span class="kw">yhat</span>(m,x),</span>
<span id="cb4-7"><a href="#cb4-7"></a>        <span class="dt">label =</span> <span class="st">&quot;Ranger RF&quot;</span>)</span></code></pre></div>
</div>
<div id="model-audit" class="section level3" number="0.1.4">
<h3><span class="header-section-number">0.1.4</span> Model audit</h3>
<p>Once we have created an explainer, it is hight time to analyze the model. Let’s start with the audit of residuals. That can lead us to an assumption which model is best, or, possibly, to exclude the worst. <code>model_performance</code> is one of the functions that serve for that purpose. It calculates residuals and basic measures creating objects that can be plotted. The figure below shows the distributions of the absolute model residuals. Red dots correspond to average, which is RMSE. Also, there are four other available geometries which are:
* ecdef
* boxplot
* gain
* lift
* histogram</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>fifa_mp_ranger &lt;-<span class="st"> </span><span class="kw">model_performance</span>(fifa_ranger_exp)</span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="kw">plot</span>(fifa_mp_ranger, <span class="dt">geom =</span> <span class="st">&quot;boxplot&quot;</span>) <span class="op">+</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Absolute residuals in Euro&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>, <span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">dollar_format</span>(<span class="dt">suffix =</span> <span class="st">&quot;€&quot;</span>, <span class="dt">prefix =</span> <span class="st">&quot;&quot;</span>)) <span class="op">+</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Distributions of model absolute residuals&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/DALEX_mp.png&quot;</span>)</span></code></pre></div>
<p><img src="images/DALEX_mp.png" width="1200" /></p>
<p>But performance is not everything. Next figure show diagnostics plots. The scatterplot shows a true target variable against model predictions. We can spot that model has predictions quite close to the true target values. Of course we can plot dependency between response and any other variable by manipulating arguments of <code>plot</code> function..</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>fifa_md_ranger &lt;-<span class="st"> </span><span class="kw">model_diagnostics</span>(fifa_ranger_exp)</span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="kw">plot</span>(fifa_md_ranger, <span class="dt">variable =</span> <span class="st">&quot;y&quot;</span>, <span class="dt">yvariable =</span> <span class="st">&quot;y_hat&quot;</span>) <span class="op">+</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Value in Euro&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>, <span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">dollar_format</span>(<span class="dt">suffix =</span> <span class="st">&quot;€&quot;</span>, <span class="dt">prefix =</span> <span class="st">&quot;&quot;</span>)) <span class="op">+</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Estimated value in Euro&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>, <span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">dollar_format</span>(<span class="dt">suffix =</span> <span class="st">&quot;€&quot;</span>, <span class="dt">prefix =</span> <span class="st">&quot;&quot;</span>)) <span class="op">+</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">slope =</span> <span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Diagnostics plot Predicted vs True target values&quot;</span>, <span class="st">&quot;&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/DALEX_md.png&quot;</span>)</span></code></pre></div>
<p><img src="images/DALEX_md.png" width="1200" /></p>
</div>
<div id="global-understanding" class="section level3" number="0.1.5">
<h3><span class="header-section-number">0.1.5</span> Global understanding</h3>
<p>The below figure shows a variable importance plot. Only 12 most important variables are presented.</p>
<p>We can see that all models share the same important variables, especially skill_ball_control and movemnet_reactions that are most important for all models except linear. However, the importance of other variables may be very different, for instance only the shallow GBM model considers team_position variable between the first 12 most valuable ones.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>fifa_vi_ranger &lt;-<span class="st"> </span><span class="kw">model_parts</span>(fifa_ranger_exp)</span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="kw">plot</span>(fifa_vi_ranger, <span class="dt">max_vars =</span> <span class="dv">12</span>, <span class="dt">bar_width =</span> <span class="dv">4</span>, <span class="dt">show_boxplots =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/DALEX_fi.png&quot;</span>)</span></code></pre></div>
<p><img src="images/DALEX_fi.png" width="1200" /></p>
<p>The next step in understanding the models is to calculate partial dependency and present them using a plot. They show the average relation between particular variables and players’ value.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>selected_variables &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;movement_reactions&quot;</span>,<span class="st">&quot;skill_ball_control&quot;</span>, <span class="st">&quot;skill_dribbling&quot;</span>)</span>
<span id="cb11-2"><a href="#cb11-2"></a></span>
<span id="cb11-3"><a href="#cb11-3"></a>fifa_pd_ranger &lt;-<span class="st"> </span><span class="kw">model_profile</span>(fifa_ranger_exp, <span class="dt">variables =</span> selected_variables)<span class="op">$</span>agr_profiles</span>
<span id="cb11-4"><a href="#cb11-4"></a></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="kw">plot</span>(fifa_pd_ranger) <span class="op">+</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Estimated value in Euro&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>, <span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">dollar_format</span>(<span class="dt">suffix =</span> <span class="st">&quot;€&quot;</span>, <span class="dt">prefix =</span> <span class="st">&quot;&quot;</span>)) <span class="op">+</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Partial Dependence profiles for selected variables&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/DALEX_pd.png&quot;</span>)</span></code></pre></div>
<p><img src="images/DALEX_pd.png" width="1200" /></p>
<p>The general direction of relation in all models is the same. The larger the player characteristic the higher is the price. With a single exception – variable Age. Possible causation is that football managers tend to put a lot of hope for the self-development of young players, and therefore the price of promising players can be unbelievably high.</p>
</div>
<div id="instance-understanding" class="section level3" number="0.1.6">
<h3><span class="header-section-number">0.1.6</span> Instance understanding</h3>
<p>Time to see how the model behaves for a single observation/player This can be done for any player, but this example we will use Robert Lewandowski, the most valuable Polish football player.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>lewandowski &lt;-<span class="st"> </span>fifa20_selected[<span class="st">&quot;Robert Lewandowski&quot;</span>,]</span>
<span id="cb13-2"><a href="#cb13-2"></a>lewandowski_bd_ranger &lt;-<span class="st"> </span><span class="kw">variable_attribution</span>(fifa_ranger_exp, <span class="dt">new_observation =</span> lewandowski)</span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="kw">plot</span>(lewandowski_bd_ranger)</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/DALEX_bd.png&quot;</span>)</span></code></pre></div>
<p><img src="images/DALEX_bd.png" width="1200" />
Above plots show estimated contrubution of varaible value to final prediction. For more information please visit introduction to <a href="https://pbiecek.github.io/ema/breakDown.html#breakDown">breakDown</a> method. Robert Lewandowski is a striker. It makes sense that his most valuable characteristics are those related with attack, like attacking_voleys or skill_dribbling.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>lewandowski_pdiag_ranger &lt;-<span class="st"> </span><span class="kw">predict_diagnostics</span>(fifa_ranger_exp, <span class="dt">new_observation =</span> lewandowski)</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="kw">plot</span>(lewandowski_pdiag_ranger)</span></code></pre></div>
<p>Plot above shows residuals for all observations against residuals for 50 closest neighbours of Robert Lewandowski. Clearly, among neighbours he has the most expensive players and therefore their residuals are much higher than average residuals.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/DALEX_pdiag.png&quot;</span>)</span></code></pre></div>
<p><img src="images/DALEX_pdiag.png" width="1200" /></p>
</div>
<div id="models-comparison" class="section level3" number="0.1.7">
<h3><span class="header-section-number">0.1.7</span> Models comparison</h3>
<p>So we have already introduced the basics of DALEX package and simple know-how of explaining the predictive model. Now we are going to show how explanations can be used to explain more than one model at once and compare them trying to determine which one is better. For that purpose we will create three more models along with their explainers:</p>
<ul>
<li>shallow gbm</li>
<li>deep gbm</li>
<li>linear model.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># remotes::install_github(&quot;mlr3learners/mlr3learners.gbm&quot;)</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="kw">library</span>(<span class="st">&quot;mlr3learners.gbm&quot;</span>)</span>
<span id="cb17-3"><a href="#cb17-3"></a>fifa_task &lt;-<span class="st"> </span>TaskRegr<span class="op">$</span><span class="kw">new</span>(<span class="dt">id =</span> <span class="st">&quot;FIFA20&quot;</span>, <span class="dt">backend =</span> fifa20_selected, <span class="dt">target =</span> <span class="st">&quot;value_eur&quot;</span>)</span>
<span id="cb17-4"><a href="#cb17-4"></a>fifa_gbm_shallow &lt;-<span class="st"> </span><span class="kw">lrn</span>(<span class="st">&quot;regr.gbm&quot;</span>)</span>
<span id="cb17-5"><a href="#cb17-5"></a>fifa_gbm_shallow<span class="op">$</span>param_set<span class="op">$</span>values &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">n.trees =</span> <span class="dv">250</span>,</span>
<span id="cb17-6"><a href="#cb17-6"></a>                                          <span class="dt">interaction.depth =</span> <span class="dv">1</span>,</span>
<span id="cb17-7"><a href="#cb17-7"></a>                                          <span class="dt">distribution =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb17-8"><a href="#cb17-8"></a>                                          <span class="dt">n.minobsinnode =</span> <span class="dv">10</span>)</span>
<span id="cb17-9"><a href="#cb17-9"></a>fifa_gbm_shallow<span class="op">$</span><span class="kw">train</span>(fifa_task)</span>
<span id="cb17-10"><a href="#cb17-10"></a>fifa_gbm_deep &lt;-<span class="st"> </span><span class="kw">lrn</span>(<span class="st">&quot;regr.gbm&quot;</span>)</span>
<span id="cb17-11"><a href="#cb17-11"></a>fifa_gbm_deep<span class="op">$</span>param_set<span class="op">$</span>values &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">n.trees =</span> <span class="dv">250</span>,</span>
<span id="cb17-12"><a href="#cb17-12"></a>                                          <span class="dt">interaction.depth =</span> <span class="dv">4</span>,</span>
<span id="cb17-13"><a href="#cb17-13"></a>                                          <span class="dt">distribution =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb17-14"><a href="#cb17-14"></a>                                          <span class="dt">n.minobsinnode =</span> <span class="dv">10</span>)</span>
<span id="cb17-15"><a href="#cb17-15"></a>fifa_gbm_deep<span class="op">$</span><span class="kw">train</span>(fifa_task)</span>
<span id="cb17-16"><a href="#cb17-16"></a></span>
<span id="cb17-17"><a href="#cb17-17"></a>fifa_linear &lt;-<span class="st"> </span><span class="kw">lrn</span>(<span class="st">&quot;regr.lm&quot;</span>)</span>
<span id="cb17-18"><a href="#cb17-18"></a>fifa_linear<span class="op">$</span><span class="kw">train</span>(fifa_task)</span>
<span id="cb17-19"><a href="#cb17-19"></a></span>
<span id="cb17-20"><a href="#cb17-20"></a><span class="kw">library</span>(<span class="st">&quot;DALEX&quot;</span>)</span>
<span id="cb17-21"><a href="#cb17-21"></a><span class="kw">library</span>(<span class="st">&quot;DALEXtra&quot;</span>)</span>
<span id="cb17-22"><a href="#cb17-22"></a>fifa_gbm_exp_deep &lt;-<span class="st"> </span><span class="kw">explain_mlr3</span>(fifa_gbm_deep,</span>
<span id="cb17-23"><a href="#cb17-23"></a>        <span class="dt">data =</span> fifa20_selected, <span class="dt">y =</span> <span class="dv">10</span><span class="op">^</span>fifa20_selected<span class="op">$</span>value_eur,</span>
<span id="cb17-24"><a href="#cb17-24"></a>        <span class="dt">predict_function =</span> <span class="cf">function</span>(m,x) <span class="dv">10</span><span class="op">^</span><span class="kw">yhat</span>(m,x),</span>
<span id="cb17-25"><a href="#cb17-25"></a>        <span class="dt">label =</span> <span class="st">&quot;GBM deep&quot;</span>)</span>
<span id="cb17-26"><a href="#cb17-26"></a></span>
<span id="cb17-27"><a href="#cb17-27"></a>fifa_gbm_exp_shallow &lt;-<span class="st"> </span><span class="kw">explain_mlr3</span>(fifa_gbm_shallow,</span>
<span id="cb17-28"><a href="#cb17-28"></a>        <span class="dt">data =</span> fifa20_selected, <span class="dt">y =</span> <span class="dv">10</span><span class="op">^</span>fifa20_selected<span class="op">$</span>value_eur,</span>
<span id="cb17-29"><a href="#cb17-29"></a>        <span class="dt">predict_function =</span> <span class="cf">function</span>(m,x) <span class="dv">10</span><span class="op">^</span><span class="kw">yhat</span>(m,x),</span>
<span id="cb17-30"><a href="#cb17-30"></a>        <span class="dt">label =</span> <span class="st">&quot;GBM shallow&quot;</span>)</span>
<span id="cb17-31"><a href="#cb17-31"></a></span>
<span id="cb17-32"><a href="#cb17-32"></a>fifa_ranger_exp &lt;-<span class="st"> </span><span class="kw">explain_mlr3</span>(fifa_ranger,</span>
<span id="cb17-33"><a href="#cb17-33"></a>        <span class="dt">data =</span> fifa20_selected, <span class="dt">y =</span> <span class="dv">10</span><span class="op">^</span>fifa20_selected<span class="op">$</span>value_eur,</span>
<span id="cb17-34"><a href="#cb17-34"></a>        <span class="dt">predict_function =</span> <span class="cf">function</span>(m,x) <span class="dv">10</span><span class="op">^</span><span class="kw">yhat</span>(m,x),</span>
<span id="cb17-35"><a href="#cb17-35"></a>        <span class="dt">label =</span> <span class="st">&quot;Ranger RF&quot;</span>)</span>
<span id="cb17-36"><a href="#cb17-36"></a></span>
<span id="cb17-37"><a href="#cb17-37"></a>fifa_linear_exp &lt;-<span class="st"> </span><span class="kw">explain_mlr3</span>(fifa_linear,</span>
<span id="cb17-38"><a href="#cb17-38"></a>        <span class="dt">data =</span> fifa20_selected, <span class="dt">y =</span> <span class="dv">10</span><span class="op">^</span>fifa20_selected<span class="op">$</span>value_eur,</span>
<span id="cb17-39"><a href="#cb17-39"></a>        <span class="dt">predict_function =</span> <span class="cf">function</span>(m,x) <span class="dv">10</span><span class="op">^</span><span class="kw">yhat</span>(m,x),</span>
<span id="cb17-40"><a href="#cb17-40"></a>        <span class="dt">label =</span> <span class="st">&quot;Linear Model&quot;</span>)</span></code></pre></div>
<p>Starting from the beginning, distribution of residuals can be a helpful tool that allows us to distinguish models and point the best of the worst. <code>plot.model_performance</code> functions allow us to pass more than one <code>model_performance</code> class object and plot them all together.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>fifa_mp_gbm_deep &lt;-<span class="st"> </span><span class="kw">model_performance</span>(fifa_gbm_exp_deep)</span>
<span id="cb18-2"><a href="#cb18-2"></a>fifa_mp_gbm_shallow &lt;-<span class="st"> </span><span class="kw">model_performance</span>(fifa_gbm_exp_shallow)</span>
<span id="cb18-3"><a href="#cb18-3"></a>fifa_mp_linear &lt;-<span class="st"> </span><span class="kw">model_performance</span>(fifa_linear_exp)</span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="kw">plot</span>(fifa_mp_gbm_shallow, fifa_mp_gbm_deep, fifa_mp_ranger, fifa_mp_linear, <span class="dt">geom =</span> <span class="st">&quot;boxplot&quot;</span>) <span class="op">+</span></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Absolute residuals in Euro&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>, <span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">dollar_format</span>(<span class="dt">suffix =</span> <span class="st">&quot;€&quot;</span>, <span class="dt">prefix =</span> <span class="st">&quot;&quot;</span>)) <span class="op">+</span></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Distributions of model absolute residuals&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/DALEX_mp_multi.png&quot;</span>)</span></code></pre></div>
<p><img src="images/DALEX_mp_multi.png" width="1200" /></p>
<p>We can spot that previously choosen Ranger Random Forest Model has the smallest residuals on the average. Smilliar observation can be made if we take scatter plot of y and y_hat but this time use facet and plot results for four models at once. There is not need to deeply look into that plot in order to realize that points in the down rigth corner are the closest to black line indicating perfect model.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>fifa_md_gbm_shallow &lt;-<span class="st"> </span><span class="kw">model_diagnostics</span>(fifa_gbm_exp_shallow)</span>
<span id="cb20-2"><a href="#cb20-2"></a>fifa_md_gbm_deep &lt;-<span class="st"> </span><span class="kw">model_diagnostics</span>(fifa_gbm_exp_deep)</span>
<span id="cb20-3"><a href="#cb20-3"></a>fifa_md_linear &lt;-<span class="st"> </span><span class="kw">model_diagnostics</span>(fifa_linear_exp)</span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="kw">plot</span>(fifa_md_gbm_shallow, fifa_md_gbm_deep,</span>
<span id="cb20-5"><a href="#cb20-5"></a>                fifa_md_ranger, fifa_md_linear,</span>
<span id="cb20-6"><a href="#cb20-6"></a>     <span class="dt">variable =</span> <span class="st">&quot;y&quot;</span>, <span class="dt">yvariable =</span> <span class="st">&quot;y_hat&quot;</span>) <span class="op">+</span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Value in Euro&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>, <span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">dollar_format</span>(<span class="dt">suffix =</span> <span class="st">&quot;€&quot;</span>, <span class="dt">prefix =</span> <span class="st">&quot;&quot;</span>)) <span class="op">+</span></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Estimated value in Euro&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>, <span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">dollar_format</span>(<span class="dt">suffix =</span> <span class="st">&quot;€&quot;</span>, <span class="dt">prefix =</span> <span class="st">&quot;&quot;</span>)) <span class="op">+</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>label) <span class="op">+</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">slope =</span> <span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Diagnostics plot Predicted vs True target values&quot;</span>, <span class="st">&quot;&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/DALEX_md_multi.png&quot;</span>)</span></code></pre></div>
<p><img src="images/DALEX_md_multi.png" width="1200" /></p>
<p>Variable importance for models can also be plotted together to simplify comparison of them. Once again 12 the most important variables will be shown. We can see that models tend to account for variables differently. For instance, the most important variable for both gbm’s and ranger is not even in the top 5 for a linear model.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>fifa_vi_gbm_shallow &lt;-<span class="st"> </span><span class="kw">model_parts</span>(fifa_gbm_exp_shallow)</span>
<span id="cb22-2"><a href="#cb22-2"></a>fifa_vi_gbm_deep &lt;-<span class="st"> </span><span class="kw">model_parts</span>(fifa_gbm_exp_deep)</span>
<span id="cb22-3"><a href="#cb22-3"></a>fifa_vi_linear &lt;-<span class="st"> </span><span class="kw">model_parts</span>(fifa_linear_exp)</span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="kw">plot</span>(fifa_vi_gbm_shallow, fifa_vi_gbm_deep,</span>
<span id="cb22-5"><a href="#cb22-5"></a>     fifa_vi_ranger, fifa_vi_linear,</span>
<span id="cb22-6"><a href="#cb22-6"></a>     <span class="dt">max_vars =</span> <span class="dv">12</span>, <span class="dt">bar_width =</span> <span class="dv">4</span>, <span class="dt">show_boxplots =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/DALEX_fi_multi.png&quot;</span>)</span></code></pre></div>
<p><img src="images/DALEX_fi_multi.png" width="1200" /></p>
<p><code>DALEX</code> allows users to easily compare profiles of variables. (Tutaj skończył mi się wena na dziś.)</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>selected_variables &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;movement_reactions&quot;</span>,<span class="st">&quot;skill_ball_control&quot;</span>, <span class="st">&quot;skill_dribbling&quot;</span>)</span>
<span id="cb24-2"><a href="#cb24-2"></a>fifa_pd_gbm_shallow &lt;-<span class="st"> </span><span class="kw">model_profile</span>(fifa_gbm_exp_shallow, <span class="dt">variables =</span> selected_variables)<span class="op">$</span>agr_profiles</span>
<span id="cb24-3"><a href="#cb24-3"></a>fifa_pd_gbm_deep &lt;-<span class="st"> </span><span class="kw">model_profile</span>(fifa_gbm_exp_deep, <span class="dt">variables =</span> selected_variables)<span class="op">$</span>agr_profiles</span>
<span id="cb24-4"><a href="#cb24-4"></a>fifa_pd_linear &lt;-<span class="st"> </span><span class="kw">model_profile</span>(fifa_linear_exp, <span class="dt">variables =</span> selected_variables)<span class="op">$</span>agr_profiles</span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="kw">plot</span>(fifa_pd_gbm_shallow, fifa_pd_gbm_deep, fifa_pd_ranger, fifa_pd_linear) <span class="op">+</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Estimated value in Euro&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>, <span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">dollar_format</span>(<span class="dt">suffix =</span> <span class="st">&quot;€&quot;</span>, <span class="dt">prefix =</span> <span class="st">&quot;&quot;</span>)) <span class="op">+</span></span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Partial Dependence profiles for selected variables&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/DALEX_pd_multi.png&quot;</span>)</span></code></pre></div>
<p><img src="images/DALEX_pd_multi.png" width="1200" /></p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>


    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/mlr-org/mlr3book/edit/master/bookdown/%s",
"text": "Edit this chapter"
},
"history": {
"link": "https://github.com/mlr-org/mlr3book/commits/master/%s",
"text": "Edit history"
},
"view": {
"link": null,
"text": null
},
"download": [["mlr3book.pdf", "PDF"]],
"toc": {
"collapse": "section"
},
"search": false
});
});
</script>

</body>

</html>
